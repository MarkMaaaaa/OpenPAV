
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Logic flow - OpenPAV Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#logic-flow" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OpenPAV Documentation" class="md-header__button md-logo" aria-label="OpenPAV Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenPAV Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Logic flow
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OpenPAV Documentation" class="md-nav__button md-logo" aria-label="OpenPAV Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OpenPAV Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model-calibration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model Calibration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulation-integration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulation Integration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vehicle-selection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vehicle Selection
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#logic-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Logic Flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logic Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#codebase-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Codebase Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step1-define-the-yaml-file" class="md-nav__link">
    <span class="md-ellipsis">
      Step1: Define the yaml file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step2-construct-scenario-carla-only" class="md-nav__link">
    <span class="md-ellipsis">
      Step2: Construct scenario (CARLA only)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step2-construct-scenario-co-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      Step2: Construct scenario (Co-Simulation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step3-execute-a-single-step" class="md-nav__link">
    <span class="md-ellipsis">
      Step3: Execute a single step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step4-keep-the-simulation-loop-running" class="md-nav__link">
    <span class="md-ellipsis">
      Step4: Keep the simulation loop running
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step5-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Step5: Evaluation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Logic flow</h1>

<h2 id="logic-flow">Logic Flow</h2>
<p>In this section,  we will introduce the logic flow of conducting a 
scenario test in OpenCDA.</p>
<h3 id="codebase-structure">Codebase Structure</h3>
<p>Check the <a href="../codebase_structure/">codebase structure</a> to see how the codes distributed in OpenCDA.</p>
<h3 id="overview">Overview</h3>
<p>As the figure below depicts, to run simulation testings in OpenCDA, there are five general steps:</p>
<ol>
<li>The user has to first write a yaml file to configure the settings of simulation server (e.g. sync mode vs async mode), 
the specifications of the traffic flow (e.g. the number of human drive vehicles, spawn positions), and the parameters of 
each Connected Automated  Vehicle (e.g. lidar parameters, detection model, trajectory smoothness).</li>
<li>The <strong> Scenario Manager </strong> will load the yaml file, and deliver the necessary information to CARLA
server to set simulation setting, create traffic flow and generate the CAVs. Each CAV is managed by a class called 
<code>VehicleManager</code>.</li>
<li>The simulation server information will be passed to each <code>VehicleManager</code>. Based on whether the corresponding cooperative modules are activated, the <code>VehicleManager</code> will select different perception, localization, and planning modules to send the planned trajectory to the <code>ControlManager</code>. The controller will produce control commands and deliver to the  simulation server.</li>
<li>The simulation server will apply the received control commands to the vehicles, execute a single step, and return the updated information to the <code>VehicleManager</code> for next round running.</li>
<li>After simulation is over, <code>EvaluaitonManager</code> will evaluate different modules' performance and save the statistics.</li>
</ol>
<p><img alt="" src="../images/flow.png" /></p>
<h3 id="step1-define-the-yaml-file">Step1: Define the yaml file</h3>
<p>Check the <a href="../yaml_define/">Yaml Define Rule</a> to see how to write a yaml file to define your scenario.</p>
<h3 id="step2-construct-scenario-carla-only">Step2: Construct scenario (CARLA only)</h3>
<p>If the simulation only requires CARLA simulator, then after the yaml file is given, the <strong>Scenario Manager</strong> will load the file
and construct the scenario through <code>opencda.sim_api</code>. </p>
<p>The users need to first load the yaml file into a dictionary, and initialize the <code>ScenarioManager</code>.</p>
<pre><code class="language-python">import opencda.scenario_testing.utils.sim_api as sim_api

# Aad yaml file into a dictionary
scenario_params = load_yaml(config_yaml)

# Create CAV world object to store all CAV VehicleManager info.
# this is the key element to achieve cooperation
cav_world = CavWorld(opt.apply_ml)

# create scenario manager
scenario_manager = sim_api.ScenarioManager(scenario_params,
                                           opt.apply_ml,
                                           town='Town06',
                                           cav_world=cav_world)
</code></pre>
<p>Afterwards, the platoons and single CAVs will be generated.</p>
<pre><code class="language-python"># create a list of platoon
platoon_list = scenario_manager.create_platoon_manager(
        map_helper=map_api.spawn_helper_2lanefree,
        data_dump=False)

# create a list of single CAV
single_cav_list = scenario_manager.create_vehicle_manager(application=['single'])
</code></pre>
<p>Next, the traffic flow is prodced. Check <a href="traffic_generation.html#carla-traffic-manager">CARLA Traffic Generation</a> to see more details about CARLA traffic generation.</p>
<pre><code class="language-python"># create background traffic under Carla
traffic_manager, bg_veh_list = scenario_manager.create_traffic_carla()
</code></pre>
<p>Finally, create the <code>EvaluationManager</code></p>
<pre><code class="language-python">from opencda.scenario_testing.evaluations.evaluate_manager import EvaluationManager
eval_manager = \
    EvaluationManager(scenario_manager.cav_world,
                      script_name='platoon_joining_town06_carla',
                      current_time=scenario_params['current_time'])
</code></pre>
<h3 id="step2-construct-scenario-co-simulation">Step2: Construct scenario (Co-Simulation)</h3>
<p>Constructing a scenario under co-simulation setting is very similar with building scenario 
in CARLA only. There are only two differences: 1) Co-simulation requires addtional Sumo files. 2)
Instead of using <code>ScenarioManager</code>, <code>CoScenarioManager</code> is used to control the traffic. Check
<a href="traffic_generation.html#sumo-traffic-management-co-simulation">Traffic Generation under Sumo</a> section to see more details.</p>
<pre><code class="language-python">import opencda.scenario_testing.utils.cosim_api as sim_api

# there should be a Town06.sumocfg, a Town06.net.xml, and a Town06.rou.xml in
# Town06 folder
sumo_cfg = 'Town06'

# create co-simulation scenario manager
scenario_manager = \
    sim_api.CoScenarioManager(scenario_params,
                              opt.apply_ml,
                               town='Town06',
                              cav_world=cav_world,
                              sumo_file_parent_path=sumo_cfg)
</code></pre>
<h3 id="step3-execute-a-single-step">Step3: Execute a single step</h3>
<p>A simplified class diagram design is shown below.
The core class in OpenCDA is <code>VehicleManager</code>, which is the base class for any cooperative driving applications (e.g. <code>PlatoonManager</code> is built upon <code>VehicleManager</code> ). It contains the necessary modules such as <code>PerceptionManager</code> and
<code>LocalizationManager</code>.</p>
<p><img alt="" src="../images/class_diagram.png" /></p>
<p>Based on whether certain cooperative driving application is activated,
<code>VehicleManager</code> will choose different perception/localization/planning manager.</p>
<pre><code class="language-python"># vehicle_manager.py
class VehicleManager:
    def __init__(self, vehicle, config_yaml, application, carla_map, cav_world):
        if 'platooning' in application:
            platoon_config = config_yaml['platoon']
            self.agent = PlatooningBehaviorAgent(vehicle, self, self.v2x_manager,
                                                 behavior_config, platoon_config, carla_map)
        else:
            self.agent = BehaviorAgent(vehicle, carla_map, behavior_config)

</code></pre>
<p>During runtime, <code>VehicleManager</code> will first localize and detect the surrounding objects,
and then pass the computed information to v2x stack, planner and controller. Then the donwstream
modules will fuse information from different CAVs, generate trajectory and control commands.</p>
<pre><code class="language-python">class VehicleManager:
    def update_info(self):
        # localization
        self.localizer.localize()
        ego_pos = self.localizer.get_ego_pos()
        ego_spd = self.localizer.get_ego_spd()

        # object detection
        objects = self.perception_manager.detect(ego_pos)

        self.v2x_manager.update_info(ego_pos, ego_spd)
        self.agent.update_information(ego_pos, ego_spd, objects)
        # pass position and speed info to controller
        self.controller.update_info(ego_pos, ego_spd)

    def run_step(self, target_speed=None):
        target_speed, target_pos = self.agent.run_step(target_speed)
        control = self.controller.run_step(target_speed, target_pos)
        return control

</code></pre>
<h3 id="step4-keep-the-simulation-loop-running">Step4: Keep the simulation loop running</h3>
<pre><code class="language-python">while True:
    world.tick()
    single_cav.update_info()
    control = single_cav.run_step()
    single_cav.vehicle.apply_control(control)
</code></pre>
<h3 id="step5-evaluation">Step5: Evaluation</h3>
<p>When the simulation is over, the <code>EvaluationManager</code> will evaluate the performance,
and save the results in <code>~/OpenCDA/evluation_outputs</code></p>
<pre><code class="language-python"># create evaluation manager
eval_manager = EvaluationManager(cav_world)
eval_manager.evaluate()
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>